<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description" content="flask项目中添加搜索功能 - 崔金涛个人博客 - 作者:崔金涛"/> 
	<meta name="keywords" content="直播通,flask"/>
    <title>flask项目中添加搜索功能 - 崔金涛个人博客</title>
    <!-- Bootstrap Core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet"/>
    <!-- Custom CSS -->
    <link href="/css/blog.css" rel="stylesheet"/>
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media
    queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file://
    -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js">
      </script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js">
      </script>
    <![endif]-->
        <!-- jQuery Version 1.11.0 -->
    <script src="/js/jquery-1.11.0.js"> </script>
    <!-- Bootstrap Core JavaScript -->
    <script src="/js/bootstrap.min.js"></script>
  </head>
  
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">
              Toggle navigation
            </span>
            <span class="icon-bar">
            </span>
            <span class="icon-bar">
            </span>
            <span class="icon-bar">
            </span>
          </button>
          <a class="navbar-brand" href="/">
            首页
          </a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          		<ul class="nav navbar-nav">
			
				<li>
				  <a href="/posts/work.html">
					工作经验
				  </a>
				</li>
			
				<li>
				  <a href="/posts/study.html">
					学习笔记
				  </a>
				</li>
			
				<li>
				  <a href="/posts/other.html">
					随笔
				  </a>
				</li>
			
		</ul>  
        </div>
        <!-- /.navbar-collapse -->
      </div>
      <!-- /.container -->
    </nav>
    <!-- Page Content -->
    <div class="container">
      <div class="row">
        <!-- Blog Entries Column -->
        <div class="col-md-8">
          <!-- Navi -->
<a href="/">首页</a>&nbsp;>&nbsp;<a href="/posts/study.html">学习笔记</a>&nbsp;>&nbsp;正文
<!-- Title -->
<h2>flask项目中添加搜索功能</h2>
<b>标签：</b><a href="/tags.html#直播通"><i>直播通</i></a>, <a href="/tags.html#flask"><i>flask</i></a>
<div class="post-date">
	<span class="glyphicon glyphicon-time"></span>
	2017-01-15
</div>
<br/>

<!-- content -->
<div style="text-indent:2em;">
<p>这部分内容的起因是我想在自己的flask项目直播通中加入一个搜索框用来搜索数据库中的主播姓名，于是在网上搜索flask 搜索关键字，当时没注意出来的都是全文搜索的教程，一步步做下来却发现原来根本和自己的需求不符合，可见弄清需求是多么重要啊！虽然走了点弯路，却意外发现了全文搜索的方法。</p>

<h2 id="设置搜索框">设置搜索框</h2>
<p>考虑到用户体验，这里想做导航栏上的搜索框，也就是全局搜索框，这就要用到flask中的程序上下文g，在处理请求时用作临时存储的对象，每次请求都会重设这个变量。很显然，这里就需要将一个搜索框设置成为程序上下文，具体做法如下。</p>

<ul>
  <li>创建搜索框
很简单，在forms中添加
    <pre><code>class SearchForm(Form):
  search = StringField(u'', validators=[Required()])
</code></pre>
    <p>这里的Required是必须的，否则每次点击搜索按钮都会运行搜索函数，web性能下降。</p>
  </li>
  <li>定义全局变量
在main.view中写入：
    <pre><code>@main.before_app_request
def before_request(): #定义全局变量
  g.search_form = SearchForm()
</code></pre>
    <p>就将一个搜索框设置成为了程序上下文变量。</p>
  </li>
  <li>创建搜索和搜索结果的视图函数
    <pre><code>@main.route('/search', methods = ['POST'])
def search():
  if not g.search_form.validate_on_submit():
      return redirect(url_for('.index'))
  return redirect(url_for('.search_results', query = g.search_form.search.data))
@main.route('/search-results/&lt;query&gt;')
def search_results(query):
  pass
</code></pre>
  </li>
  <li>在模板中添加搜索框</li>
</ul>

<pre><code>&lt;form class="navbar-form navbar-left" action="" method="post" role="search"&gt;
	&lt;div class="form-group"&gt;
		
		&lt;input type="text" name="search" class="form-control" placeholder="Search"&gt;
	&lt;/div&gt;
	&lt;button type="submit" class="btn btn-default"&gt;搜索&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>要注意flask_wtf的请求跨站保护和表单的name属性设置。
这样，一个全局搜索框就创建好啦！</p>

<h2 id="模糊搜索">模糊搜索</h2>
<p>模糊搜索其实很简单，只要对数据库中进行模糊检索即可，一条语句适用于很多场合：</p>
<pre><code>User.query.filter(User.name.like('%'+query+'%')).all()
</code></pre>

<h2 id="全文搜索">全文搜索</h2>
<p>虽然有的时候模糊搜索很方便，但对于某些任务，比如搜索出现某些关键词的文章的时候就不能用模糊搜索了，因为不管关键词顺序还是空格都会影响模糊搜索的查询结果，这个时候就需要用到全文搜索。</p>

<p>这里有一款实现全文搜索的良好flask扩展：WhooshAlchemy，在项目中应用也只需要简单几步：</p>

<ul>
  <li>安装： <code>pip install flask_whooshalchemy</code></li>
  <li>配置： 在配置文件config.py中写入要应用全文搜索的数据库路径：<code>WHOOSH_BASE=</code></li>
  <li>索引对象：在models.py中需要全文搜索的对象中加入<code>__searchable__=['COLUMN']</code>,COLOMN为需要搜索的列</li>
  <li>在manage中添加索引：<code>whooshalchemy.whoosh_index(app, Model)</code></li>
  <li>最后在搜索时加入<code>Model.query.whoosh_search('keyword').all()</code>即可
注意：使用whooshalchemy进行搜索要现将数据库中的要搜索的对象实例全部删除，这样才能创建索引，否则会报错。</li>
</ul>

</div>

<br/>
<b>原创文章，转载请注明出处！</b>
<br/>
<b>本文链接：</b><a href="http://localhost:4000/posts/search.html" title="">http://localhost:4000/posts/search.html</a>

<!-- next and previous -->
<div style="margin-top:15px; margin-bottom:10px">
  
  <span class="next">
    上篇：
    <a href="/posts/gunicorn.html">
      项目部署路上的坑
    </a>
  </span>
   
  
  <div style="float:right">
  <span class="prev" >
    下篇：
    <a href="/posts/zhibotong.html">
      关于直播通
    </a>
  </span>
  </div>
  
</div>
<hr>
<!-- Blog Comments -->
<div class="media">
   
</div>
        </div>
        <!-- Blog Sidebar Widgets Column -->
        <div class="col-md-4">
          <!-- Blog Categories Well -->
          <div class="well">
            <h4>
              栏目分类
            </h4>
            <div class="row">
                            <div class="col-lg-6">
                <ul class="list-unstyled">
                  <li>
                    <a href="/posts/work.html">
                      工作经验
                    </a>
                  </li>
                  <li>
                    <a href="/posts/study.html">
                      学习笔记
                    </a>
                  </li>
                  <li>
                    <a href="/posts/other.html">
                      随笔
                    </a>
                  </li>
                  <li>
                    <a href="/archives.html">
                      存档
                    </a>
                  </li>
                </ul>
              </div>
 
 
            </div>
            <!-- /.row -->
          </div>
		  <!-- Blog Recent Well -->
          <div class="well">
            <h4>
              最新文章
            </h4>
			<div class="row">
                            <div class="col-lg-12">
                <ul class="list-unstyled">
				
                  <li>
                    <a href="/posts/log.html">
                      为Spring Boot添加日志模块
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/mule.html">
                      通过MULE实现后端服务调用
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/bmpn.html">
                      BPMN2.0概念
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/socketio.html">
                      利用flask_socketio实现与前段的socket通信
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/shejimoshi.html">
                      大话设计模式Python实现
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/iter.html">
                      Python的迭代器，可迭代对象和生成器
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/git.html">
                      Pro Git整理
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/sicp.html">
                      SICP
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/rabbitmq.html">
                      RabbitMQ泛式
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/redis.html">
                      再看redis
                    </a>
                  </li>
				  
                </ul>
              </div> 
			</div>
          </div>
        </div>
      </div>
      <!-- /.row -->

      <!-- Footer -->
      <footer>
        <div class="row">
          <div class="col-lg-12">
                        <div style="text-align:center;margin-top:15px;">
				Copyright &copy; cuijintao.github.io, generated by Jekyll
				<br/>
            </div>
 
          </div>
          <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
      </footer>
    </div>
    <!-- /.container -->
  </body>

</html>
