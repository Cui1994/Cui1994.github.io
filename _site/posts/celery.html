<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description" content="celery初探 - 崔金涛个人博客 - 作者:崔金涛"/> 
	<meta name="keywords" content="直播通"/>
    <title>celery初探 - 崔金涛个人博客</title>
    <!-- Bootstrap Core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet"/>
    <!-- Custom CSS -->
    <link href="/css/blog.css" rel="stylesheet"/>
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media
    queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file://
    -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js">
      </script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js">
      </script>
    <![endif]-->
        <!-- jQuery Version 1.11.0 -->
    <script src="/js/jquery-1.11.0.js"> </script>
    <!-- Bootstrap Core JavaScript -->
    <script src="/js/bootstrap.min.js"></script>
  </head>
  
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">
              Toggle navigation
            </span>
            <span class="icon-bar">
            </span>
            <span class="icon-bar">
            </span>
            <span class="icon-bar">
            </span>
          </button>
          <a class="navbar-brand" href="/">
            首页
          </a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          		<ul class="nav navbar-nav">
			
				<li>
				  <a href="/posts/work.html">
					工作经验
				  </a>
				</li>
			
				<li>
				  <a href="/posts/study.html">
					学习笔记
				  </a>
				</li>
			
				<li>
				  <a href="/posts/other.html">
					随笔
				  </a>
				</li>
			
		</ul>  
        </div>
        <!-- /.navbar-collapse -->
      </div>
      <!-- /.container -->
    </nav>
    <!-- Page Content -->
    <div class="container">
      <div class="row">
        <!-- Blog Entries Column -->
        <div class="col-md-8">
          <!-- Navi -->
<a href="/">首页</a>&nbsp;>&nbsp;<a href="/posts/study.html">学习笔记</a>&nbsp;>&nbsp;正文
<!-- Title -->
<h2>celery初探</h2>
<b>标签：</b><a href="/tags.html#直播通"><i>直播通</i></a>
<div class="post-date">
	<span class="glyphicon glyphicon-time"></span>
	2017-01-11
</div>
<br/>

<!-- content -->
<div style="text-indent:2em;">
<p>捣鼓了两天自己的直播通项目，终于大概有了雏形，在主页的视图函数中集成了爬虫，爬取用户关注主播的在线hangtag。但在运行时发现打开主页时延迟明显，有时候竟然长达数秒，突然想起了之前了解到的celery，试试能不能解决这一问题。</p>

<h2 id="celery是什么">celery是什么</h2>
<p>关于celery的知识全部在网上了解，星星点点，但还是有所收获。celery是一个典型的异步任务系统，在应用上下文之外执行任务，将消耗资源的东西通通交给celery来做，可以让主机迅速向应客户端的请求。</p>

<p>celery有三个核心组件：</p>

<ul>
  <li>客户端：在flask系统中和flask一起运行</li>
  <li>workers：就是传说中的second terminal，用来执行异步任务，可以有多个</li>
  <li>消息代理：用来进行celery的通信，一般用redis。</li>
</ul>

<p>为什么用redis？因为其实时性强，一般用作数据频繁插入，更新或者删除的任务中，以减少对数据库的操作</p>

<h2 id="让celery跑起来">让celery跑起来</h2>

<p>这部分还是比较简单的，有几个主要步骤。</p>

<ul>
  <li>安装之后要在配置文件中写入用作消息代理的redis的服务器，两行搞定。
    <pre><code>CELERY_BROKER_URL = 'redis://localhost:6379/0'
CELERY_RESULT_BACKEND = 'redis://localhost:6379/0'
</code></pre>
  </li>
  <li>之后创建celery实例，这里是直接抄来的，至于原因还没搞懂。
    <pre><code>celery = Celery(__name__, broker=Config.CELERY_BROKER_URL)
celery.conf.update(app.config)
</code></pre>
  </li>
  <li>创建celery任务，使用装饰器，先跑起来再说。
    <pre><code>@celery.task(name='circle_task')
def circletask():
  logging.info('lalala')
</code></pre>
  </li>
</ul>

<p>之后满怀信心，直接打开三个终端开始有样学样，第一个打开redis-server，第二个运行app，第三个打开celery，抄了个命令:</p>
<pre><code>$ celery -A manage.celery worker --loglevel=info
</code></pre>

<p>然而打开后发现没有动静，才想起并没有提供任务执行的delay。随即又想到我的目的是进行计划任务，让任务可以固定时间重复进行，直接开始搜celery进行实现的方法，还好google够强大，又找到了下面的配置方法：</p>
<pre><code>CELERYBEAT_SCHEDULE = {
        'every-minute': {
            'task': 'circle_task',
            #'schedule': crontab(minute='*/1'),
            # 'args': (1,2),
            'schedule': timedelta(seconds=60)
        	},
    	}
</code></pre>

<p>运行命令也变成了：</p>
<pre><code>$ celery -A manage.celery worker --loglevel=info --beat
$ celery -A proj worker -B -l info
</code></pre>

<p>至于里面的参数，只知道timedelta和crontab都可以设置间隔时间，其他的没有深入了解。将代码改好后运行celery，问题来了。</p>

<ul>
  <li>首先是celery说任务方法没有注册：
    <pre><code>Received unregistered task of type 'circle_task'.
The message has been ignored and discarded.
</code></pre>
  </li>
</ul>

<p>在stack overflow溜达了一圈，终于找到解决方法，在配置文件中声明这个方法即可，于是：</p>
<pre><code>CELERY_IMPORTS = ['app.task']
</code></pre>
<p>解决成功。这里千万注意加app，天知道我经历了什么。</p>

<ul>
  <li>之后运行celery，终于不报错了天呐，屏幕上也出现了lalala的logging，这还说什么，改代码！在task中添加了之前在index视图函数中的爬虫部分，运行celery，好，可以运行。等等，这一大片红字是什么！
    <pre><code>'RuntimeError: application not registered on db 
         instance and no application bound to current context
</code></pre>
    <p>原来是没有程序上下文不能进行sqlalchemy的操作，于是，在程序段前添加</p>
    <pre><code>with app.app_context():
</code></pre>
    <p>成功！</p>
  </li>
</ul>

<p><img src="http://i1.piimg.com/567571/88020dc0eeab8185.png" alt="此处输入图片的描述" /></p>

<p>最后终于成功看到了模拟上线提醒的logging字样，激动万分，编程的大起大落真是…哈！</p>

</div>

<br/>
<b>原创文章，转载请注明出处！</b>
<br/>
<b>本文链接：</b><a href="http://localhost:4000/posts/celery.html" title="">http://localhost:4000/posts/celery.html</a>

<!-- next and previous -->
<div style="margin-top:15px; margin-bottom:10px">
   
  
  <div style="float:right">
  <span class="prev" >
    下篇：
    <a href="/posts/gunicorn.html">
      项目部署路上的坑
    </a>
  </span>
  </div>
  
</div>
<hr>
<!-- Blog Comments -->
<div class="media">
   
</div>
        </div>
        <!-- Blog Sidebar Widgets Column -->
        <div class="col-md-4">
          <!-- Blog Categories Well -->
          <div class="well">
            <h4>
              栏目分类
            </h4>
            <div class="row">
                            <div class="col-lg-6">
                <ul class="list-unstyled">
                  <li>
                    <a href="/posts/work.html">
                      工作经验
                    </a>
                  </li>
                  <li>
                    <a href="/posts/study.html">
                      学习笔记
                    </a>
                  </li>
                  <li>
                    <a href="/posts/other.html">
                      随笔
                    </a>
                  </li>
                  <li>
                    <a href="/archives.html">
                      存档
                    </a>
                  </li>
                </ul>
              </div>
 
 
            </div>
            <!-- /.row -->
          </div>
		  <!-- Blog Recent Well -->
          <div class="well">
            <h4>
              最新文章
            </h4>
			<div class="row">
                            <div class="col-lg-12">
                <ul class="list-unstyled">
				
                  <li>
                    <a href="/posts/zhibotong.html">
                      关于直播通
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/search.html">
                      flask项目中添加搜索功能
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/gunicorn.html">
                      项目部署路上的坑
                    </a>
                  </li>
				
                  <li>
                    <a href="/posts/celery.html">
                      celery初探
                    </a>
                  </li>
				  
                </ul>
              </div> 
			</div>
          </div>
        </div>
      </div>
      <!-- /.row -->

      <!-- Footer -->
      <footer>
        <div class="row">
          <div class="col-lg-12">
                        <div style="text-align:center;margin-top:15px;">
				Copyright &copy; cuijintao.github.io, generated by Jekyll
				<br/>
            </div>
 
          </div>
          <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
      </footer>
    </div>
    <!-- /.container -->
  </body>

</html>
